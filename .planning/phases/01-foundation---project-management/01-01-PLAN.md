---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - drizzle.config.ts
  - .env.local
  - .env.example
  - src/lib/db/schema.ts
  - src/lib/db/index.ts
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/middleware.ts
  - src/middleware.ts
autonomous: true

user_setup:
  - service: supabase
    why: "Managed PostgreSQL database + authentication"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection string (URI)"
    dashboard_config:
      - task: "Create a new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"

must_haves:
  truths:
    - "Next.js 15 application runs with npm run dev"
    - "Supabase clients are configured and can connect"
    - "Database schema exists with projects table"
    - "RLS policies enforce user-level data isolation"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "next"
    - path: "src/lib/db/schema.ts"
      provides: "Drizzle schema with projects table"
      contains: "pgTable"
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client"
      contains: "createServerClient"
    - path: "src/lib/supabase/client.ts"
      provides: "Client-side Supabase client"
      contains: "createBrowserClient"
  key_links:
    - from: "src/lib/db/index.ts"
      to: "DATABASE_URL"
      via: "drizzle-orm postgres connection"
      pattern: "process\\.env\\.DATABASE_URL"
    - from: "src/lib/supabase/server.ts"
      to: "NEXT_PUBLIC_SUPABASE_URL"
      via: "Supabase client initialization"
      pattern: "process\\.env\\.NEXT_PUBLIC_SUPABASE"
---

<objective>
Set up Next.js 15 application with Supabase integration and database schema.

Purpose: Establish the foundation for all subsequent development - the application scaffolding, database connectivity, and data model that everything else builds upon.

Output: Running Next.js application with configured Supabase clients and a projects table ready for CRUD operations.
</objective>

<execution_context>
@/home/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation---project-management/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js application with dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    src/app/layout.tsx
    src/app/page.tsx
    .gitignore
  </files>
  <action>
Create a new Next.js 15 application in the project root using create-next-app with App Router:

```bash
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --use-npm
```

Then install additional dependencies:
```bash
npm install @supabase/supabase-js @supabase/ssr drizzle-orm postgres zod
npm install -D drizzle-kit @types/node
```

Update next.config.ts to use the new configuration format (Next.js 15 uses .ts config):
```typescript
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  // Future config options here
}

export default nextConfig
```

Keep the default App Router structure. Verify the application runs with `npm run dev`.
  </action>
  <verify>
`npm run dev` starts successfully and http://localhost:3000 shows the Next.js welcome page.
`npm ls next` shows next@15.x installed.
`npm ls drizzle-orm` shows drizzle-orm installed.
  </verify>
  <done>
Next.js 15 application created with all required dependencies installed. Dev server runs successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Supabase clients</name>
  <files>
    .env.local
    .env.example
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/middleware.ts
    src/middleware.ts
  </files>
  <action>
Create environment files:

**.env.example** (committed to git - template for other developers):
```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
DATABASE_URL=your_database_url
```

**.env.local** (gitignored - actual values from user_setup):
```
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
DATABASE_URL=
```

Create browser client **src/lib/supabase/client.ts**:
```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

Create server client **src/lib/supabase/server.ts**:
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Ignore errors in Server Components where cookies can't be modified
          }
        },
      },
    }
  )
}
```

Create middleware helper **src/lib/supabase/middleware.ts**:
```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // Refreshing the auth token
  await supabase.auth.getUser()

  return supabaseResponse
}
```

Create middleware **src/middleware.ts**:
```typescript
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

Ensure .env.local is in .gitignore.
  </action>
  <verify>
Files exist: src/lib/supabase/client.ts, src/lib/supabase/server.ts, src/lib/supabase/middleware.ts, src/middleware.ts
.env.example exists and is committed.
.env.local exists and is gitignored.
TypeScript compilation passes: `npx tsc --noEmit`
  </verify>
  <done>
Supabase client files created following official @supabase/ssr patterns. Environment template ready for user configuration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database schema with Drizzle + RLS</name>
  <files>
    drizzle.config.ts
    src/lib/db/schema.ts
    src/lib/db/index.ts
    supabase/migrations/00001_create_projects.sql
  </files>
  <action>
Create Drizzle config **drizzle.config.ts**:
```typescript
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  schema: './src/lib/db/schema.ts',
  out: './supabase/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
})
```

Create database schema **src/lib/db/schema.ts**:
```typescript
import { pgTable, uuid, text, timestamp } from 'drizzle-orm/pg-core'

export const projects = pgTable('projects', {
  id: uuid('id').defaultRandom().primaryKey(),
  userId: uuid('user_id').notNull(),
  name: text('name').notNull(),
  description: text('description'),
  clientName: text('client_name').notNull(),
  clientEmail: text('client_email'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})

// Type exports for use in application
export type Project = typeof projects.$inferSelect
export type NewProject = typeof projects.$inferInsert
```

Create database client **src/lib/db/index.ts**:
```typescript
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import * as schema from './schema'

const connectionString = process.env.DATABASE_URL!

// For query purposes
const queryClient = postgres(connectionString)
export const db = drizzle(queryClient, { schema })
```

Create SQL migration with RLS **supabase/migrations/00001_create_projects.sql**:
```sql
-- Create projects table
CREATE TABLE IF NOT EXISTS projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  client_name TEXT NOT NULL,
  client_email TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- Enable Row Level Security
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;

-- Policy: Users can view their own projects
CREATE POLICY "Users can view own projects"
  ON projects
  FOR SELECT
  USING (auth.uid() = user_id);

-- Policy: Users can create their own projects
CREATE POLICY "Users can create own projects"
  ON projects
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Policy: Users can update their own projects
CREATE POLICY "Users can update own projects"
  ON projects
  FOR UPDATE
  USING (auth.uid() = user_id);

-- Policy: Users can delete their own projects
CREATE POLICY "Users can delete own projects"
  ON projects
  FOR DELETE
  USING (auth.uid() = user_id);

-- Create index for faster user-specific queries
CREATE INDEX idx_projects_user_id ON projects(user_id);

-- Create updated_at trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_projects_updated_at
  BEFORE UPDATE ON projects
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

Add npm script for migrations in package.json:
```json
"scripts": {
  "db:generate": "drizzle-kit generate",
  "db:push": "drizzle-kit push",
  "db:studio": "drizzle-kit studio"
}
```

NOTE: The SQL migration file should be run manually in Supabase SQL Editor until user configures DATABASE_URL. Include instructions in .env.example.
  </action>
  <verify>
Files exist: drizzle.config.ts, src/lib/db/schema.ts, src/lib/db/index.ts, supabase/migrations/00001_create_projects.sql
`npx tsc --noEmit` passes without errors.
package.json contains db:generate, db:push, db:studio scripts.
  </verify>
  <done>
Database schema defined with Drizzle ORM. RLS policies written for user-level data isolation. Migration file ready to run in Supabase.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` starts the application successfully
2. `npx tsc --noEmit` shows no TypeScript errors
3. All files in files_modified list exist
4. .env.example committed to git, .env.local gitignored
5. Migration SQL file is valid and ready for Supabase execution
</verification>

<success_criteria>
1. Next.js 15 application runs on localhost:3000
2. Supabase client files exist and are TypeScript-valid
3. Database schema defines projects table with user isolation
4. RLS policies exist for SELECT, INSERT, UPDATE, DELETE
5. Environment configuration is templated correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation---project-management/01-01-SUMMARY.md`
</output>
